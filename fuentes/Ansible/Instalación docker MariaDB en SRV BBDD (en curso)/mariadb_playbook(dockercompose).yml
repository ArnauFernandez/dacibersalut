---
- name: Instalación de Docker y despliegue de MariaDB con Docker Compose
  hosts: mariadb
  become: true

  tasks:
    # Instalación de Docker y Docker Compose
    - name: Instalar Docker
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Instalar Docker Compose
      apt:
        name: docker-compose
        state: present
        update_cache: yes

    # Crear directorio para Docker Compose
    - name: Crear directorio /srv/mariadb
      file:
        path: /srv/mariadb
        state: directory
        mode: 0755

    # Copiar archivos de Docker Compose
    - name: Copiar docker-compose.yml
      copy:
        src: docker-compose.yml
        dest: /srv/mariadb/docker-compose.yml

    # Ejecutar Docker Compose
    - name: Levantar servicios con Docker Compose
      command: docker-compose up -d
      args:
        chdir: /srv/mariadb

    - name: Crear el volum Docker "ohv"
      docker_volume:
        name: ohv
        state: present

    - name: Crear i executar el contenidor de MariaDB
      docker_container:
        name: openhospital
        image: mariadb:latest
        state: started
        restart_policy: always
      ports:
        - "3306:3306"
      env:
        MYSQL_ROOT_PASSWORD: "ciber25"
      volumes:
        - ohv:/var/lib/mysql


    - name: Ejecutar el script mariadb_playbook(dockercompose).yml con bash
      command: bash mariadb_playbook(dockercompose).yml
      args:
        chdir: /srv/mariadb
